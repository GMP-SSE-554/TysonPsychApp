using System;
using System.Collections.Generic;
using System.Linq;
using System.Timers;

namespace SSE554Project1
{
    public class Slideshow
    {
        ExcelReader excelReader;
        Timer timer = new Timer();
        string currentAnswer;
        int currentSlideIndex = 0;
        public bool slideshowFinished = false;
        List<Slide> slideList = new List<Slide>();
        MainWindow mainWindow = null;

        public Slideshow(string excelSheetAddress)
        {
            excelReader = new ExcelReader(excelSheetAddress);
            GenerateSlides();
            timer.Elapsed += AdvanceSlide;
            currentAnswer = "";
            UpdateTimers();
        }

        public Slideshow(string excelSheetAddress, MainWindow window)
        {
            excelReader = new ExcelReader(excelSheetAddress);
            GenerateSlides();
            timer.Elapsed += AdvanceSlide;
            currentAnswer = "";
            UpdateTimers();
            mainWindow = window;
        }

        private void GenerateSlides()
        {
            List<String> slideTextList;
            List<int> slideTimeList;
            List<bool> userInteractionList;

            slideTextList = excelReader.ReadColumn(2);
            slideTimeList = excelReader.ReadColumn(3).Select(int.Parse).ToList();
            userInteractionList = excelReader.ReadColumn(4).Select(bool.Parse).ToList();

            //Generate slides based on data read from excel sheet
            for (int i = 0; i < slideTextList.Count; i++)
            {
                slideList.Add(new Slide(slideTextList[i], slideTimeList[i], userInteractionList[i]));
            }

            excelReader.Close();
        }

        public void BeginSlideshow()
        {

        }

        public void AdvanceSlide()
        {
            slideList[currentSlideIndex].SubmitAnswer(currentAnswer);
            currentAnswer = "";
            currentSlideIndex++;

            if (currentSlideIndex >= slideList.Count())
            {
                slideshowFinished = true;
                timer.Stop();
                excelReader.WriteSlidesToFile(slideList);
            }
            else
            {
                UpdateTimers();
            }

            if (mainWindow != null)
            {
                mainWindow.Update();
            }
        }

        public async void AdvanceSlide(Object source, ElapsedEventArgs e)
        {
            timer.Stop();
            AdvanceSlide();
        }

        public void ExportAnswers(string outputFilePath)
        {
            
        }

        public void SetAnswer(string answer)
        {
            currentAnswer = answer;
        }

        public List<Slide> GetSlides()
        {
            return slideList;
        }

        public Slide GetCurrentSlide()
        {
            return slideList[currentSlideIndex];
        }

        public bool IsFinished()
        {
            return slideshowFinished;
        }

        private void UpdateTimers()
        {
            //Set up timer based on current slide's time limit
            if (slideList[currentSlideIndex].GetTimeLimit() > 0)
            {
                timer.Interval = slideList[currentSlideIndex].GetTimeLimit() * 1000;
                timer.Start();
            }
            else
            {
                timer.Stop();
            }

            slideList[currentSlideIndex].Initiate();
        }
    }
}
